import { __assign, __awaiter, __generator } from "tslib";
jest.useFakeTimers("modern");
var now = 1613699814645;
jest.setSystemTime(now);
var mockParseKnowFiles = jest.fn();
var mockGetMasterProfileName = jest.fn();
jest.mock("@aws-sdk/credential-provider-ini", function () { return ({
    parseKnownFiles: mockParseKnowFiles,
    getMasterProfileName: mockGetMasterProfileName,
}); });
var mockReadFileSync = jest.fn();
jest.mock("fs", function () { return ({ readFileSync: mockReadFileSync }); });
var mockRoleCredentials = {
    roleCredentials: {
        accessKeyId: "key",
        secretAccessKey: "secret",
        sessionToken: "token",
        expiration: Date.now(),
    },
};
var mockSSOSend = jest.fn().mockReturnValue(Promise.resolve(mockRoleCredentials));
var mockGetRoleCredentialsCommand = jest.fn();
jest.mock("@aws-sdk/client-sso", function () { return ({
    SSOClient: function () {
        return { send: mockSSOSend };
    },
    GetRoleCredentialsCommand: mockGetRoleCredentialsCommand,
}); });
import { EXPIRE_WINDOW_MS, fromSSO } from "./index";
var toRFC3339String = function (date) {
    var timestamp = new Date(date).toISOString();
    return timestamp.replace(/\.[\d]+Z$/, "Z");
};
describe("fromSSO", function () {
    var ssoConfig = {
        sso_start_url: "https:some-url/start",
        sso_account_id: "1234567890",
        sso_region: "us-foo-1",
        sso_role_name: "some-role",
    };
    var token = {
        startUrl: ssoConfig.sso_start_url,
        region: ssoConfig.sso_region,
        accessToken: "base64 encoded string",
        expiresAt: toRFC3339String(now + 60 * 60 * 1000),
    };
    beforeEach(function () {
        mockParseKnowFiles.mockClear();
        mockGetMasterProfileName.mockClear();
        mockReadFileSync.mockClear();
        mockSSOSend.mockClear();
    });
    it("should fetch credentials from resolved token file", function () { return __awaiter(void 0, void 0, void 0, function () {
        var roleCredentials, _a;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
                    mockGetMasterProfileName.mockReturnValue("default");
                    mockReadFileSync.mockReturnValue(JSON.stringify(token));
                    roleCredentials = mockRoleCredentials.roleCredentials;
                    _a = expect;
                    return [4 /*yield*/, fromSSO()()];
                case 1:
                    _a.apply(void 0, [_b.sent()]).toEqual(__assign(__assign({}, roleCredentials), { expiration: new Date(roleCredentials.expiration) }));
                    expect(mockReadFileSync.mock.calls[0][0]).toEqual(expect.stringMatching(/fcab95d6966151d97d9ee7776a90d895b5e5fbe6.json$/));
                    expect(mockReadFileSync.mock.calls[0][1]).toMatchObject({ encoding: "utf-8" });
                    expect(mockGetRoleCredentialsCommand).toHaveBeenCalledWith({
                        accountId: ssoConfig.sso_account_id,
                        roleName: ssoConfig.sso_role_name,
                        accessToken: token.accessToken,
                    });
                    return [2 /*return*/];
            }
        });
    }); });
    it("should allow supplying custom client", function () { return __awaiter(void 0, void 0, void 0, function () {
        var newSSOClient;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
                    mockGetMasterProfileName.mockReturnValue("default");
                    mockReadFileSync.mockReturnValue(JSON.stringify(token));
                    newSSOClient = { send: jest.fn().mockReturnValue(Promise.resolve(mockRoleCredentials)) };
                    //@ts-expect-error
                    return [4 /*yield*/, fromSSO({ ssoClient: newSSOClient })()];
                case 1:
                    //@ts-expect-error
                    _a.sent();
                    expect(newSSOClient.send).toHaveBeenCalled();
                    expect(mockSSOSend).not.toHaveBeenCalled();
                    return [2 /*return*/];
            }
        });
    }); });
    it("should throw if profile doesn't exist in the config files", function () {
        var profile = "exist";
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ non_exist: { foo: "bar" } }));
        mockGetMasterProfileName.mockReturnValue(profile);
        return expect(function () { return __awaiter(void 0, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, fromSSO()()];
                    case 1:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        }); }).rejects.toMatchObject({
            message: "Profile " + profile + " could not be found in shared credentials file.",
            tryNextLink: true,
        });
    });
    it("should throw if profile is not configured with SSO credential", function () {
        var _a;
        var profile = "exist";
        mockParseKnowFiles.mockReturnValue(Promise.resolve((_a = {}, _a[profile] = { foo: "bar" }, _a)));
        mockGetMasterProfileName.mockReturnValue(profile);
        return expect(function () { return __awaiter(void 0, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, fromSSO()()];
                    case 1:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        }); }).rejects.toMatchObject({
            message: "Profile " + profile + " is not configured with SSO credentials.",
            tryNextLink: true,
        });
    });
    var _loop_1 = function (i) {
        var keyToRemove = Object.keys(ssoConfig)[i];
        it("should throw if sso configuration is missing " + keyToRemove, function () { return __awaiter(void 0, void 0, void 0, function () {
            var config, e_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        expect.assertions(2);
                        config = __assign({}, ssoConfig);
                        //@ts-ignore
                        delete config[keyToRemove];
                        mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: config }));
                        mockGetMasterProfileName.mockReturnValue("default");
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, fromSSO()()];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        e_1 = _a.sent();
                        expect(e_1.message).toContain("Profile default does not have valid SSO credentials.");
                        expect(e_1.tryNextLink).toBeFalsy();
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        }); });
    };
    for (var i = 0; i < Object.keys(ssoConfig).length; i++) {
        _loop_1(i);
    }
    it("should throw if token cache file is not found", function () { return __awaiter(void 0, void 0, void 0, function () {
        var e_2;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    expect.assertions(2);
                    mockReadFileSync.mockImplementation(function () {
                        throw new Error("File not found.");
                    });
                    mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
                    mockGetMasterProfileName.mockReturnValue("default");
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 3, , 4]);
                    return [4 /*yield*/, fromSSO()()];
                case 2:
                    _a.sent();
                    return [3 /*break*/, 4];
                case 3:
                    e_2 = _a.sent();
                    expect(e_2.message).toContain("The SSO session associated with this profile has expired or is otherwise invalid.");
                    expect(e_2.tryNextLink).toBeFalsy();
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    }); });
    it("should throw if token cache file is invalid", function () { return __awaiter(void 0, void 0, void 0, function () {
        var e_3;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    expect.assertions(2);
                    mockReadFileSync.mockReturnValue("invalid JSON content");
                    mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
                    mockGetMasterProfileName.mockReturnValue("default");
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 3, , 4]);
                    return [4 /*yield*/, fromSSO()()];
                case 2:
                    _a.sent();
                    return [3 /*break*/, 4];
                case 3:
                    e_3 = _a.sent();
                    expect(e_3.message).toContain("The SSO session associated with this profile has expired or is otherwise invalid.");
                    expect(e_3.tryNextLink).toBeFalsy();
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    }); });
    it("should throw if token cache is expired", function () { return __awaiter(void 0, void 0, void 0, function () {
        var e_4;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    expect.assertions(2);
                    mockReadFileSync.mockReturnValue(__assign(__assign({}, token), { expiration: toRFC3339String(now + EXPIRE_WINDOW_MS - 2) }));
                    mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
                    mockGetMasterProfileName.mockReturnValue("default");
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 3, , 4]);
                    return [4 /*yield*/, fromSSO()()];
                case 2:
                    _a.sent();
                    return [3 /*break*/, 4];
                case 3:
                    e_4 = _a.sent();
                    expect(e_4.message).toContain("The SSO session associated with this profile has expired or is otherwise invalid.");
                    expect(e_4.tryNextLink).toBeFalsy();
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    }); });
    it("should throw if SSO client throws", function () { return __awaiter(void 0, void 0, void 0, function () {
        var clientError, e_5;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    expect.assertions(3);
                    mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
                    mockGetMasterProfileName.mockReturnValue("default");
                    mockReadFileSync.mockReturnValue(JSON.stringify(token));
                    clientError = new Error("No account is found for the user");
                    //@ts-ignore
                    clientError.$fault = "client";
                    mockSSOSend.mockImplementation(function () { return __awaiter(void 0, void 0, void 0, function () {
                        return __generator(this, function (_a) {
                            throw clientError;
                        });
                    }); });
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 3, , 4]);
                    return [4 /*yield*/, fromSSO()()];
                case 2:
                    _a.sent();
                    return [3 /*break*/, 4];
                case 3:
                    e_5 = _a.sent();
                    expect(e_5.message).toContain(clientError.message);
                    expect(e_5.tryNextLink).toBeFalsy();
                    expect(e_5.$fault).toBe("client");
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    }); });
    it("should throw if credentials from SSO client is invalid", function () { return __awaiter(void 0, void 0, void 0, function () {
        var e_6;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    expect.assertions(2);
                    mockReadFileSync.mockReturnValue(JSON.stringify(token));
                    mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
                    mockGetMasterProfileName.mockReturnValue("default");
                    mockSSOSend.mockResolvedValue({
                        roleCredentials: __assign(__assign({}, mockRoleCredentials.roleCredentials), { accessKeyId: undefined }),
                    });
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 3, , 4]);
                    return [4 /*yield*/, fromSSO()()];
                case 2:
                    _a.sent();
                    return [3 /*break*/, 4];
                case 3:
                    e_6 = _a.sent();
                    expect(e_6.message).toContain("SSO returns an invalid temporary credential.");
                    expect(e_6.tryNextLink).toBeFalsy();
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    }); });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguc3BlYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmRleC5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzdCLElBQU0sR0FBRyxHQUFHLGFBQWEsQ0FBQztBQUMxQixJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBRXhCLElBQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3JDLElBQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQzNDLElBQUksQ0FBQyxJQUFJLENBQUMsa0NBQWtDLEVBQUUsY0FBTSxPQUFBLENBQUM7SUFDbkQsZUFBZSxFQUFFLGtCQUFrQjtJQUNuQyxvQkFBb0IsRUFBRSx3QkFBd0I7Q0FDL0MsQ0FBQyxFQUhrRCxDQUdsRCxDQUFDLENBQUM7QUFFSixJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNuQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxjQUFNLE9BQUEsQ0FBQyxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLEVBQXBDLENBQW9DLENBQUMsQ0FBQztBQUU1RCxJQUFNLG1CQUFtQixHQUFHO0lBQzFCLGVBQWUsRUFBRTtRQUNmLFdBQVcsRUFBRSxLQUFLO1FBQ2xCLGVBQWUsRUFBRSxRQUFRO1FBQ3pCLFlBQVksRUFBRSxPQUFPO1FBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO0tBQ3ZCO0NBQ0YsQ0FBQztBQUNGLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7QUFDcEYsSUFBTSw2QkFBNkIsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFF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O29CQUM1RSx3QkFBd0IsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ3BELFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQzt3QkFDNUIsZUFBZSx3QkFBTyxtQkFBbUIsQ0FBQyxlQUFlLEtBQUUsV0FBVyxFQUFFLFNBQVMsR0FBRTtxQkFDcEYsQ0FBQyxDQUFDOzs7O29CQUVELHFCQUFNLE9BQU8sRUFBRSxFQUFFLEVBQUE7O29CQUFqQixTQUFpQixDQUFDOzs7O29CQUVsQixNQUFNLENBQUMsR0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO29CQUM1RSxNQUFNLENBQUMsR0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDOzs7OztTQUVyQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImplc3QudXNlRmFrZVRpbWVycyhcIm1vZGVyblwiKTtcbmNvbnN0IG5vdyA9IDE2MTM2OTk4MTQ2NDU7XG5qZXN0LnNldFN5c3RlbVRpbWUobm93KTtcblxuY29uc3QgbW9ja1BhcnNlS25vd0ZpbGVzID0gamVzdC5mbigpO1xuY29uc3QgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lID0gamVzdC5mbigpO1xuamVzdC5tb2NrKFwiQGF3cy1zZGsvY3JlZGVudGlhbC1wcm92aWRlci1pbmlcIiwgKCkgPT4gKHtcbiAgcGFyc2VLbm93bkZpbGVzOiBtb2NrUGFyc2VLbm93RmlsZXMsXG4gIGdldE1hc3RlclByb2ZpbGVOYW1lOiBtb2NrR2V0TWFzdGVyUHJvZmlsZU5hbWUsXG59KSk7XG5cbmNvbnN0IG1vY2tSZWFkRmlsZVN5bmMgPSBqZXN0LmZuKCk7XG5qZXN0Lm1vY2soXCJmc1wiLCAoKSA9PiAoeyByZWFkRmlsZVN5bmM6IG1vY2tSZWFkRmlsZVN5bmMgfSkpO1xuXG5jb25zdCBtb2NrUm9sZUNyZWRlbnRpYWxzID0ge1xuICByb2xlQ3JlZGVudGlhbHM6IHtcbiAgICBhY2Nlc3NLZXlJZDogXCJrZXlcIixcbiAgICBzZWNyZXRBY2Nlc3NLZXk6IFwic2VjcmV0XCIsXG4gICAgc2Vzc2lvblRva2VuOiBcInRva2VuXCIsXG4gICAgZXhwaXJhdGlvbjogRGF0ZS5ub3coKSxcbiAgfSxcbn07XG5jb25zdCBtb2NrU1NPU2VuZCA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoUHJvbWlzZS5yZXNvbHZlKG1vY2tSb2xlQ3JlZGVudGlhbHMpKTtcbmNvbnN0IG1vY2tHZXRSb2xlQ3JlZGVudGlhbHNDb21tYW5kID0gamVzdC5mbigpO1xuamVzdC5tb2NrKFwiQGF3cy1zZGsvY2xpZW50LXNzb1wiLCAoKSA9PiAoe1xuICBTU09DbGllbnQ6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4geyBzZW5kOiBtb2NrU1NPU2VuZCB9O1xuICB9LFxuICBHZXRSb2xlQ3JlZGVudGlhbHNDb21tYW5kOiBtb2NrR2V0Um9sZUNyZWRlbnRpYWxzQ29tbWFuZCxcbn0pKTtcblxuaW1wb3J0IHsgRVhQSVJFX1dJTkRPV19NUywgZnJvbVNTTyB9IGZyb20gXCIuL2luZGV4XCI7XG5cbmNvbnN0IHRvUkZDMzMzOVN0cmluZyA9IChkYXRlOiBudW1iZXIpOiBzdHJpbmcgPT4ge1xuICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZShkYXRlKS50b0lTT1N0cmluZygpO1xuICByZXR1cm4gdGltZXN0YW1wLnJlcGxhY2UoL1xcLltcXGRdK1okLywgXCJaXCIpO1xufTtcblxuZGVzY3JpYmUoXCJmcm9tU1NPXCIsICgpID0+IHtcbiAgY29uc3Qgc3NvQ29uZmlnID0ge1xuICAgIHNzb19zdGFydF91cmw6IFwiaHR0cHM6c29tZS11cmwvc3RhcnRcIixcbiAgICBzc29fYWNjb3VudF9pZDogXCIxMjM0NTY3ODkwXCIsXG4gICAgc3NvX3JlZ2lvbjogXCJ1cy1mb28tMVwiLFxuICAgIHNzb19yb2xlX25hbWU6IFwic29tZS1yb2xlXCIsXG4gIH07XG4gIGNvbnN0IHRva2VuID0ge1xuICAgIHN0YXJ0VXJsOiBzc29Db25maWcuc3NvX3N0YXJ0X3VybCxcbiAgICByZWdpb246IHNzb0NvbmZpZy5zc29fcmVnaW9uLFxuICAgIGFjY2Vzc1Rva2VuOiBcImJhc2U2NCBlbmNvZGVkIHN0cmluZ1wiLFxuICAgIGV4cGlyZXNBdDogdG9SRkMzMzM5U3RyaW5nKG5vdyArIDYwICogNjAgKiAxMDAwKSxcbiAgfTtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbW9ja1BhcnNlS25vd0ZpbGVzLm1vY2tDbGVhcigpO1xuICAgIG1vY2tHZXRNYXN0ZXJQcm9maWxlTmFtZS5tb2NrQ2xlYXIoKTtcbiAgICBtb2NrUmVhZEZpbGVTeW5jLm1vY2tDbGVhcigpO1xuICAgIG1vY2tTU09TZW5kLm1vY2tDbGVhcigpO1xuICB9KTtcblxuICBpdChcInNob3VsZCBmZXRjaCBjcmVkZW50aWFscyBmcm9tIHJlc29sdmVkIHRva2VuIGZpbGVcIiwgYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tQYXJzZUtub3dGaWxlcy5tb2NrUmV0dXJuVmFsdWUoUHJvbWlzZS5yZXNvbHZlKHsgZGVmYXVsdDogc3NvQ29uZmlnIH0pKTtcbiAgICBtb2NrR2V0TWFzdGVyUHJvZmlsZU5hbWUubW9ja1JldHVyblZhbHVlKFwiZGVmYXVsdFwiKTtcbiAgICBtb2NrUmVhZEZpbGVTeW5jLm1vY2tSZXR1cm5WYWx1ZShKU09OLnN0cmluZ2lmeSh0b2tlbikpO1xuICAgIGNvbnN0IHsgcm9sZUNyZWRlbnRpYWxzIH0gPSBtb2NrUm9sZUNyZWRlbnRpYWxzO1xuICAgIGV4cGVjdChhd2FpdCBmcm9tU1NPKCkoKSkudG9FcXVhbCh7IC4uLnJvbGVDcmVkZW50aWFscywgZXhwaXJhdGlvbjogbmV3IERhdGUocm9sZUNyZWRlbnRpYWxzLmV4cGlyYXRpb24pIH0pO1xuICAgIGV4cGVjdChtb2NrUmVhZEZpbGVTeW5jLm1vY2suY2FsbHNbMF1bMF0pLnRvRXF1YWwoXG4gICAgICBleHBlY3Quc3RyaW5nTWF0Y2hpbmcoL2ZjYWI5NWQ2OTY2MTUxZDk3ZDllZTc3NzZhOTBkODk1YjVlNWZiZTYuanNvbiQvKVxuICAgICk7XG4gICAgZXhwZWN0KG1vY2tSZWFkRmlsZVN5bmMubW9jay5jYWxsc1swXVsxXSkudG9NYXRjaE9iamVjdCh7IGVuY29kaW5nOiBcInV0Zi04XCIgfSk7XG4gICAgZXhwZWN0KG1vY2tHZXRSb2xlQ3JlZGVudGlhbHNDb21tYW5kKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICBhY2NvdW50SWQ6IHNzb0NvbmZpZy5zc29fYWNjb3VudF9pZCxcbiAgICAgIHJvbGVOYW1lOiBzc29Db25maWcuc3NvX3JvbGVfbmFtZSxcbiAgICAgIGFjY2Vzc1Rva2VuOiB0b2tlbi5hY2Nlc3NUb2tlbixcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoXCJzaG91bGQgYWxsb3cgc3VwcGx5aW5nIGN1c3RvbSBjbGllbnRcIiwgYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tQYXJzZUtub3dGaWxlcy5tb2NrUmV0dXJuVmFsdWUoUHJvbWlzZS5yZXNvbHZlKHsgZGVmYXVsdDogc3NvQ29uZmlnIH0pKTtcbiAgICBtb2NrR2V0TWFzdGVyUHJvZmlsZU5hbWUubW9ja1JldHVyblZhbHVlKFwiZGVmYXVsdFwiKTtcbiAgICBtb2NrUmVhZEZpbGVTeW5jLm1vY2tSZXR1cm5WYWx1ZShKU09OLnN0cmluZ2lmeSh0b2tlbikpO1xuICAgIGNvbnN0IG5ld1NTT0NsaWVudCA9IHsgc2VuZDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShQcm9taXNlLnJlc29sdmUobW9ja1JvbGVDcmVkZW50aWFscykpIH07XG4gICAgLy9AdHMtZXhwZWN0LWVycm9yXG4gICAgYXdhaXQgZnJvbVNTTyh7IHNzb0NsaWVudDogbmV3U1NPQ2xpZW50IH0pKCk7XG4gICAgZXhwZWN0KG5ld1NTT0NsaWVudC5zZW5kKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgZXhwZWN0KG1vY2tTU09TZW5kKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICB9KTtcblxuICBpdChcInNob3VsZCB0aHJvdyBpZiBwcm9maWxlIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNvbmZpZyBmaWxlc1wiLCAoKSA9PiB7XG4gICAgY29uc3QgcHJvZmlsZSA9IFwiZXhpc3RcIjtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IG5vbl9leGlzdDogeyBmb286IFwiYmFyXCIgfSB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShwcm9maWxlKTtcbiAgICByZXR1cm4gZXhwZWN0KGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZyb21TU08oKSgpO1xuICAgIH0pLnJlamVjdHMudG9NYXRjaE9iamVjdCh7XG4gICAgICBtZXNzYWdlOiBgUHJvZmlsZSAke3Byb2ZpbGV9IGNvdWxkIG5vdCBiZSBmb3VuZCBpbiBzaGFyZWQgY3JlZGVudGlhbHMgZmlsZS5gLFxuICAgICAgdHJ5TmV4dExpbms6IHRydWUsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KFwic2hvdWxkIHRocm93IGlmIHByb2ZpbGUgaXMgbm90IGNvbmZpZ3VyZWQgd2l0aCBTU08gY3JlZGVudGlhbFwiLCAoKSA9PiB7XG4gICAgY29uc3QgcHJvZmlsZSA9IFwiZXhpc3RcIjtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IFtwcm9maWxlXTogeyBmb286IFwiYmFyXCIgfSB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShwcm9maWxlKTtcbiAgICByZXR1cm4gZXhwZWN0KGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZyb21TU08oKSgpO1xuICAgIH0pLnJlamVjdHMudG9NYXRjaE9iamVjdCh7XG4gICAgICBtZXNzYWdlOiBgUHJvZmlsZSAke3Byb2ZpbGV9IGlzIG5vdCBjb25maWd1cmVkIHdpdGggU1NPIGNyZWRlbnRpYWxzLmAsXG4gICAgICB0cnlOZXh0TGluazogdHJ1ZSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBPYmplY3Qua2V5cyhzc29Db25maWcpLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3Qga2V5VG9SZW1vdmUgPSBPYmplY3Qua2V5cyhzc29Db25maWcpW2ldO1xuICAgIGl0KGBzaG91bGQgdGhyb3cgaWYgc3NvIGNvbmZpZ3VyYXRpb24gaXMgbWlzc2luZyAke2tleVRvUmVtb3ZlfWAsIGFzeW5jICgpID0+IHtcbiAgICAgIGV4cGVjdC5hc3NlcnRpb25zKDIpO1xuICAgICAgY29uc3QgY29uZmlnID0geyAuLi5zc29Db25maWcgfTtcbiAgICAgIC8vQHRzLWlnbm9yZVxuICAgICAgZGVsZXRlIGNvbmZpZ1trZXlUb1JlbW92ZV07XG4gICAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IGRlZmF1bHQ6IGNvbmZpZyB9KSk7XG4gICAgICBtb2NrR2V0TWFzdGVyUHJvZmlsZU5hbWUubW9ja1JldHVyblZhbHVlKFwiZGVmYXVsdFwiKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZyb21TU08oKSgpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBleHBlY3QoZS5tZXNzYWdlKS50b0NvbnRhaW4oXCJQcm9maWxlIGRlZmF1bHQgZG9lcyBub3QgaGF2ZSB2YWxpZCBTU08gY3JlZGVudGlhbHMuXCIpO1xuICAgICAgICBleHBlY3QoZS50cnlOZXh0TGluaykudG9CZUZhbHN5KCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBpdChcInNob3VsZCB0aHJvdyBpZiB0b2tlbiBjYWNoZSBmaWxlIGlzIG5vdCBmb3VuZFwiLCBhc3luYyAoKSA9PiB7XG4gICAgZXhwZWN0LmFzc2VydGlvbnMoMik7XG4gICAgbW9ja1JlYWRGaWxlU3luYy5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmlsZSBub3QgZm91bmQuXCIpO1xuICAgIH0pO1xuICAgIG1vY2tQYXJzZUtub3dGaWxlcy5tb2NrUmV0dXJuVmFsdWUoUHJvbWlzZS5yZXNvbHZlKHsgZGVmYXVsdDogc3NvQ29uZmlnIH0pKTtcbiAgICBtb2NrR2V0TWFzdGVyUHJvZmlsZU5hbWUubW9ja1JldHVyblZhbHVlKFwiZGVmYXVsdFwiKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZnJvbVNTTygpKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZXhwZWN0KGUubWVzc2FnZSkudG9Db250YWluKFwiVGhlIFNTTyBzZXNzaW9uIGFzc29jaWF0ZWQgd2l0aCB0aGlzIHByb2ZpbGUgaGFzIGV4cGlyZWQgb3IgaXMgb3RoZXJ3aXNlIGludmFsaWQuXCIpO1xuICAgICAgZXhwZWN0KGUudHJ5TmV4dExpbmspLnRvQmVGYWxzeSgpO1xuICAgIH1cbiAgfSk7XG5cbiAgaXQoXCJzaG91bGQgdGhyb3cgaWYgdG9rZW4gY2FjaGUgZmlsZSBpcyBpbnZhbGlkXCIsIGFzeW5jICgpID0+IHtcbiAgICBleHBlY3QuYXNzZXJ0aW9ucygyKTtcbiAgICBtb2NrUmVhZEZpbGVTeW5jLm1vY2tSZXR1cm5WYWx1ZShcImludmFsaWQgSlNPTiBjb250ZW50XCIpO1xuICAgIG1vY2tQYXJzZUtub3dGaWxlcy5tb2NrUmV0dXJuVmFsdWUoUHJvbWlzZS5yZXNvbHZlKHsgZGVmYXVsdDogc3NvQ29uZmlnIH0pKTtcbiAgICBtb2NrR2V0TWFzdGVyUHJvZmlsZU5hbWUubW9ja1JldHVyblZhbHVlKFwiZGVmYXVsdFwiKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZnJvbVNTTygpKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZXhwZWN0KGUubWVzc2FnZSkudG9Db250YWluKFwiVGhlIFNTTyBzZXNzaW9uIGFzc29jaWF0ZWQgd2l0aCB0aGlzIHByb2ZpbGUgaGFzIGV4cGlyZWQgb3IgaXMgb3RoZXJ3aXNlIGludmFsaWQuXCIpO1xuICAgICAgZXhwZWN0KGUudHJ5TmV4dExpbmspLnRvQmVGYWxzeSgpO1xuICAgIH1cbiAgfSk7XG5cbiAgaXQoXCJzaG91bGQgdGhyb3cgaWYgdG9rZW4gY2FjaGUgaXMgZXhwaXJlZFwiLCBhc3luYyAoKSA9PiB7XG4gICAgZXhwZWN0LmFzc2VydGlvbnMoMik7XG4gICAgbW9ja1JlYWRGaWxlU3luYy5tb2NrUmV0dXJuVmFsdWUoeyAuLi50b2tlbiwgZXhwaXJhdGlvbjogdG9SRkMzMzM5U3RyaW5nKG5vdyArIEVYUElSRV9XSU5ET1dfTVMgLSAyKSB9KTtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IGRlZmF1bHQ6IHNzb0NvbmZpZyB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShcImRlZmF1bHRcIik7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZyb21TU08oKSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGV4cGVjdChlLm1lc3NhZ2UpLnRvQ29udGFpbihcIlRoZSBTU08gc2Vzc2lvbiBhc3NvY2lhdGVkIHdpdGggdGhpcyBwcm9maWxlIGhhcyBleHBpcmVkIG9yIGlzIG90aGVyd2lzZSBpbnZhbGlkLlwiKTtcbiAgICAgIGV4cGVjdChlLnRyeU5leHRMaW5rKS50b0JlRmFsc3koKTtcbiAgICB9XG4gIH0pO1xuXG4gIGl0KFwic2hvdWxkIHRocm93IGlmIFNTTyBjbGllbnQgdGhyb3dzXCIsIGFzeW5jICgpID0+IHtcbiAgICBleHBlY3QuYXNzZXJ0aW9ucygzKTtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IGRlZmF1bHQ6IHNzb0NvbmZpZyB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShcImRlZmF1bHRcIik7XG4gICAgbW9ja1JlYWRGaWxlU3luYy5tb2NrUmV0dXJuVmFsdWUoSlNPTi5zdHJpbmdpZnkodG9rZW4pKTtcbiAgICBjb25zdCBjbGllbnRFcnJvciA9IG5ldyBFcnJvcihcIk5vIGFjY291bnQgaXMgZm91bmQgZm9yIHRoZSB1c2VyXCIpO1xuICAgIC8vQHRzLWlnbm9yZVxuICAgIGNsaWVudEVycm9yLiRmYXVsdCA9IFwiY2xpZW50XCI7XG4gICAgbW9ja1NTT1NlbmQubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgIHRocm93IGNsaWVudEVycm9yO1xuICAgIH0pO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcm9tU1NPKCkoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBleHBlY3QoZS5tZXNzYWdlKS50b0NvbnRhaW4oY2xpZW50RXJyb3IubWVzc2FnZSk7XG4gICAgICBleHBlY3QoZS50cnlOZXh0TGluaykudG9CZUZhbHN5KCk7XG4gICAgICBleHBlY3QoZS4kZmF1bHQpLnRvQmUoXCJjbGllbnRcIik7XG4gICAgfVxuICB9KTtcblxuICBpdChcInNob3VsZCB0aHJvdyBpZiBjcmVkZW50aWFscyBmcm9tIFNTTyBjbGllbnQgaXMgaW52YWxpZFwiLCBhc3luYyAoKSA9PiB7XG4gICAgZXhwZWN0LmFzc2VydGlvbnMoMik7XG4gICAgbW9ja1JlYWRGaWxlU3luYy5tb2NrUmV0dXJuVmFsdWUoSlNPTi5zdHJpbmdpZnkodG9rZW4pKTtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IGRlZmF1bHQ6IHNzb0NvbmZpZyB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShcImRlZmF1bHRcIik7XG4gICAgbW9ja1NTT1NlbmQubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgcm9sZUNyZWRlbnRpYWxzOiB7IC4uLm1vY2tSb2xlQ3JlZGVudGlhbHMucm9sZUNyZWRlbnRpYWxzLCBhY2Nlc3NLZXlJZDogdW5kZWZpbmVkIH0sXG4gICAgfSk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZyb21TU08oKSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGV4cGVjdChlLm1lc3NhZ2UpLnRvQ29udGFpbihcIlNTTyByZXR1cm5zIGFuIGludmFsaWQgdGVtcG9yYXJ5IGNyZWRlbnRpYWwuXCIpO1xuICAgICAgZXhwZWN0KGUudHJ5TmV4dExpbmspLnRvQmVGYWxzeSgpO1xuICAgIH1cbiAgfSk7XG59KTtcbiJdfQ==