"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.useFakeTimers("modern");
const now = 1613699814645;
jest.setSystemTime(now);
const mockParseKnowFiles = jest.fn();
const mockGetMasterProfileName = jest.fn();
jest.mock("@aws-sdk/credential-provider-ini", () => ({
    parseKnownFiles: mockParseKnowFiles,
    getMasterProfileName: mockGetMasterProfileName,
}));
const mockReadFileSync = jest.fn();
jest.mock("fs", () => ({ readFileSync: mockReadFileSync }));
const mockRoleCredentials = {
    roleCredentials: {
        accessKeyId: "key",
        secretAccessKey: "secret",
        sessionToken: "token",
        expiration: Date.now(),
    },
};
const mockSSOSend = jest.fn().mockReturnValue(Promise.resolve(mockRoleCredentials));
const mockGetRoleCredentialsCommand = jest.fn();
jest.mock("@aws-sdk/client-sso", () => ({
    SSOClient: function () {
        return { send: mockSSOSend };
    },
    GetRoleCredentialsCommand: mockGetRoleCredentialsCommand,
}));
const index_1 = require("./index");
const toRFC3339String = (date) => {
    const timestamp = new Date(date).toISOString();
    return timestamp.replace(/\.[\d]+Z$/, "Z");
};
describe("fromSSO", () => {
    const ssoConfig = {
        sso_start_url: "https:some-url/start",
        sso_account_id: "1234567890",
        sso_region: "us-foo-1",
        sso_role_name: "some-role",
    };
    const token = {
        startUrl: ssoConfig.sso_start_url,
        region: ssoConfig.sso_region,
        accessToken: "base64 encoded string",
        expiresAt: toRFC3339String(now + 60 * 60 * 1000),
    };
    beforeEach(() => {
        mockParseKnowFiles.mockClear();
        mockGetMasterProfileName.mockClear();
        mockReadFileSync.mockClear();
        mockSSOSend.mockClear();
    });
    it("should fetch credentials from resolved token file", async () => {
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
        mockGetMasterProfileName.mockReturnValue("default");
        mockReadFileSync.mockReturnValue(JSON.stringify(token));
        const { roleCredentials } = mockRoleCredentials;
        expect(await index_1.fromSSO()()).toEqual({ ...roleCredentials, expiration: new Date(roleCredentials.expiration) });
        expect(mockReadFileSync.mock.calls[0][0]).toEqual(expect.stringMatching(/fcab95d6966151d97d9ee7776a90d895b5e5fbe6.json$/));
        expect(mockReadFileSync.mock.calls[0][1]).toMatchObject({ encoding: "utf-8" });
        expect(mockGetRoleCredentialsCommand).toHaveBeenCalledWith({
            accountId: ssoConfig.sso_account_id,
            roleName: ssoConfig.sso_role_name,
            accessToken: token.accessToken,
        });
    });
    it("should allow supplying custom client", async () => {
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
        mockGetMasterProfileName.mockReturnValue("default");
        mockReadFileSync.mockReturnValue(JSON.stringify(token));
        const newSSOClient = { send: jest.fn().mockReturnValue(Promise.resolve(mockRoleCredentials)) };
        //@ts-expect-error
        await index_1.fromSSO({ ssoClient: newSSOClient })();
        expect(newSSOClient.send).toHaveBeenCalled();
        expect(mockSSOSend).not.toHaveBeenCalled();
    });
    it("should throw if profile doesn't exist in the config files", () => {
        const profile = "exist";
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ non_exist: { foo: "bar" } }));
        mockGetMasterProfileName.mockReturnValue(profile);
        return expect(async () => {
            await index_1.fromSSO()();
        }).rejects.toMatchObject({
            message: `Profile ${profile} could not be found in shared credentials file.`,
            tryNextLink: true,
        });
    });
    it("should throw if profile is not configured with SSO credential", () => {
        const profile = "exist";
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ [profile]: { foo: "bar" } }));
        mockGetMasterProfileName.mockReturnValue(profile);
        return expect(async () => {
            await index_1.fromSSO()();
        }).rejects.toMatchObject({
            message: `Profile ${profile} is not configured with SSO credentials.`,
            tryNextLink: true,
        });
    });
    for (let i = 0; i < Object.keys(ssoConfig).length; i++) {
        const keyToRemove = Object.keys(ssoConfig)[i];
        it(`should throw if sso configuration is missing ${keyToRemove}`, async () => {
            expect.assertions(2);
            const config = { ...ssoConfig };
            //@ts-ignore
            delete config[keyToRemove];
            mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: config }));
            mockGetMasterProfileName.mockReturnValue("default");
            try {
                await index_1.fromSSO()();
            }
            catch (e) {
                expect(e.message).toContain("Profile default does not have valid SSO credentials.");
                expect(e.tryNextLink).toBeFalsy();
            }
        });
    }
    it("should throw if token cache file is not found", async () => {
        expect.assertions(2);
        mockReadFileSync.mockImplementation(() => {
            throw new Error("File not found.");
        });
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
        mockGetMasterProfileName.mockReturnValue("default");
        try {
            await index_1.fromSSO()();
        }
        catch (e) {
            expect(e.message).toContain("The SSO session associated with this profile has expired or is otherwise invalid.");
            expect(e.tryNextLink).toBeFalsy();
        }
    });
    it("should throw if token cache file is invalid", async () => {
        expect.assertions(2);
        mockReadFileSync.mockReturnValue("invalid JSON content");
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
        mockGetMasterProfileName.mockReturnValue("default");
        try {
            await index_1.fromSSO()();
        }
        catch (e) {
            expect(e.message).toContain("The SSO session associated with this profile has expired or is otherwise invalid.");
            expect(e.tryNextLink).toBeFalsy();
        }
    });
    it("should throw if token cache is expired", async () => {
        expect.assertions(2);
        mockReadFileSync.mockReturnValue({ ...token, expiration: toRFC3339String(now + index_1.EXPIRE_WINDOW_MS - 2) });
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
        mockGetMasterProfileName.mockReturnValue("default");
        try {
            await index_1.fromSSO()();
        }
        catch (e) {
            expect(e.message).toContain("The SSO session associated with this profile has expired or is otherwise invalid.");
            expect(e.tryNextLink).toBeFalsy();
        }
    });
    it("should throw if SSO client throws", async () => {
        expect.assertions(3);
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
        mockGetMasterProfileName.mockReturnValue("default");
        mockReadFileSync.mockReturnValue(JSON.stringify(token));
        const clientError = new Error("No account is found for the user");
        //@ts-ignore
        clientError.$fault = "client";
        mockSSOSend.mockImplementation(async () => {
            throw clientError;
        });
        try {
            await index_1.fromSSO()();
        }
        catch (e) {
            expect(e.message).toContain(clientError.message);
            expect(e.tryNextLink).toBeFalsy();
            expect(e.$fault).toBe("client");
        }
    });
    it("should throw if credentials from SSO client is invalid", async () => {
        expect.assertions(2);
        mockReadFileSync.mockReturnValue(JSON.stringify(token));
        mockParseKnowFiles.mockReturnValue(Promise.resolve({ default: ssoConfig }));
        mockGetMasterProfileName.mockReturnValue("default");
        mockSSOSend.mockResolvedValue({
            roleCredentials: { ...mockRoleCredentials.roleCredentials, accessKeyId: undefined },
        });
        try {
            await index_1.fromSSO()();
        }
        catch (e) {
            expect(e.message).toContain("SSO returns an invalid temporary credential.");
            expect(e.tryNextLink).toBeFalsy();
        }
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguc3BlYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmRleC5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM3QixNQUFNLEdBQUcsR0FBRyxhQUFhLENBQUM7QUFDMUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUV4QixNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNyQyxNQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbkQsZUFBZSxFQUFFLGtCQUFrQjtJQUNuQyxvQkFBb0IsRUFBRSx3QkFBd0I7Q0FDL0MsQ0FBQyxDQUFDLENBQUM7QUFFSixNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNuQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsWUFBWSxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxDQUFDO0FBRTVELE1BQU0sbUJBQW1CLEdBQUc7SUFDMUIsZUFBZSxFQUFFO1FBQ2YsV0FBVyxFQUFFLEtBQUs7UUFDbEIsZUFBZSxFQUFFLFFBQVE7UUFDekIsWUFBWSxFQUFFLE9BQU87UUFDckIsVUFBVSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7S0FDdkI7Q0FDRixDQUFDO0FBQ0YsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztBQUNwRixNQUFNLDZCQUE2QixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNoRCxJ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LENBQUMsQ0FBQztRQUN4RCxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDNUUsd0JBQXdCLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BELFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQztZQUM1QixlQUFlLEVBQUUsRUFBRSxHQUFHLG1CQUFtQixDQUFDLGVBQWUsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFO1NBQ3BGLENBQUMsQ0FBQztRQUNILElBQUk7WUFDRixNQUFNLGVBQU8sRUFBRSxFQUFFLENBQUM7U0FDbkI7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLDhDQUE4QyxDQUFDLENBQUM7WUFDNUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNuQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJqZXN0LnVzZUZha2VUaW1lcnMoXCJtb2Rlcm5cIik7XG5jb25zdCBub3cgPSAxNjEzNjk5ODE0NjQ1O1xuamVzdC5zZXRTeXN0ZW1UaW1lKG5vdyk7XG5cbmNvbnN0IG1vY2tQYXJzZUtub3dGaWxlcyA9IGplc3QuZm4oKTtcbmNvbnN0IG1vY2tHZXRNYXN0ZXJQcm9maWxlTmFtZSA9IGplc3QuZm4oKTtcbmplc3QubW9jayhcIkBhd3Mtc2RrL2NyZWRlbnRpYWwtcHJvdmlkZXItaW5pXCIsICgpID0+ICh7XG4gIHBhcnNlS25vd25GaWxlczogbW9ja1BhcnNlS25vd0ZpbGVzLFxuICBnZXRNYXN0ZXJQcm9maWxlTmFtZTogbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLFxufSkpO1xuXG5jb25zdCBtb2NrUmVhZEZpbGVTeW5jID0gamVzdC5mbigpO1xuamVzdC5tb2NrKFwiZnNcIiwgKCkgPT4gKHsgcmVhZEZpbGVTeW5jOiBtb2NrUmVhZEZpbGVTeW5jIH0pKTtcblxuY29uc3QgbW9ja1JvbGVDcmVkZW50aWFscyA9IHtcbiAgcm9sZUNyZWRlbnRpYWxzOiB7XG4gICAgYWNjZXNzS2V5SWQ6IFwia2V5XCIsXG4gICAgc2VjcmV0QWNjZXNzS2V5OiBcInNlY3JldFwiLFxuICAgIHNlc3Npb25Ub2tlbjogXCJ0b2tlblwiLFxuICAgIGV4cGlyYXRpb246IERhdGUubm93KCksXG4gIH0sXG59O1xuY29uc3QgbW9ja1NTT1NlbmQgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZShtb2NrUm9sZUNyZWRlbnRpYWxzKSk7XG5jb25zdCBtb2NrR2V0Um9sZUNyZWRlbnRpYWxzQ29tbWFuZCA9IGplc3QuZm4oKTtcbmplc3QubW9jayhcIkBhd3Mtc2RrL2NsaWVudC1zc29cIiwgKCkgPT4gKHtcbiAgU1NPQ2xpZW50OiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHsgc2VuZDogbW9ja1NTT1NlbmQgfTtcbiAgfSxcbiAgR2V0Um9sZUNyZWRlbnRpYWxzQ29tbWFuZDogbW9ja0dldFJvbGVDcmVkZW50aWFsc0NvbW1hbmQsXG59KSk7XG5cbmltcG9ydCB7IEVYUElSRV9XSU5ET1dfTVMsIGZyb21TU08gfSBmcm9tIFwiLi9pbmRleFwiO1xuXG5jb25zdCB0b1JGQzMzMzlTdHJpbmcgPSAoZGF0ZTogbnVtYmVyKTogc3RyaW5nID0+IHtcbiAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoZGF0ZSkudG9JU09TdHJpbmcoKTtcbiAgcmV0dXJuIHRpbWVzdGFtcC5yZXBsYWNlKC9cXC5bXFxkXStaJC8sIFwiWlwiKTtcbn07XG5cbmRlc2NyaWJlKFwiZnJvbVNTT1wiLCAoKSA9PiB7XG4gIGNvbnN0IHNzb0NvbmZpZyA9IHtcbiAgICBzc29fc3RhcnRfdXJsOiBcImh0dHBzOnNvbWUtdXJsL3N0YXJ0XCIsXG4gICAgc3NvX2FjY291bnRfaWQ6IFwiMTIzNDU2Nzg5MFwiLFxuICAgIHNzb19yZWdpb246IFwidXMtZm9vLTFcIixcbiAgICBzc29fcm9sZV9uYW1lOiBcInNvbWUtcm9sZVwiLFxuICB9O1xuICBjb25zdCB0b2tlbiA9IHtcbiAgICBzdGFydFVybDogc3NvQ29uZmlnLnNzb19zdGFydF91cmwsXG4gICAgcmVnaW9uOiBzc29Db25maWcuc3NvX3JlZ2lvbixcbiAgICBhY2Nlc3NUb2tlbjogXCJiYXNlNjQgZW5jb2RlZCBzdHJpbmdcIixcbiAgICBleHBpcmVzQXQ6IHRvUkZDMzMzOVN0cmluZyhub3cgKyA2MCAqIDYwICogMTAwMCksXG4gIH07XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIG1vY2tQYXJzZUtub3dGaWxlcy5tb2NrQ2xlYXIoKTtcbiAgICBtb2NrR2V0TWFzdGVyUHJvZmlsZU5hbWUubW9ja0NsZWFyKCk7XG4gICAgbW9ja1JlYWRGaWxlU3luYy5tb2NrQ2xlYXIoKTtcbiAgICBtb2NrU1NPU2VuZC5tb2NrQ2xlYXIoKTtcbiAgfSk7XG5cbiAgaXQoXCJzaG91bGQgZmV0Y2ggY3JlZGVudGlhbHMgZnJvbSByZXNvbHZlZCB0b2tlbiBmaWxlXCIsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IGRlZmF1bHQ6IHNzb0NvbmZpZyB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShcImRlZmF1bHRcIik7XG4gICAgbW9ja1JlYWRGaWxlU3luYy5tb2NrUmV0dXJuVmFsdWUoSlNPTi5zdHJpbmdpZnkodG9rZW4pKTtcbiAgICBjb25zdCB7IHJvbGVDcmVkZW50aWFscyB9ID0gbW9ja1JvbGVDcmVkZW50aWFscztcbiAgICBleHBlY3QoYXdhaXQgZnJvbVNTTygpKCkpLnRvRXF1YWwoeyAuLi5yb2xlQ3JlZGVudGlhbHMsIGV4cGlyYXRpb246IG5ldyBEYXRlKHJvbGVDcmVkZW50aWFscy5leHBpcmF0aW9uKSB9KTtcbiAgICBleHBlY3QobW9ja1JlYWRGaWxlU3luYy5tb2NrLmNhbGxzWzBdWzBdKS50b0VxdWFsKFxuICAgICAgZXhwZWN0LnN0cmluZ01hdGNoaW5nKC9mY2FiOTVkNjk2NjE1MWQ5N2Q5ZWU3Nzc2YTkwZDg5NWI1ZTVmYmU2Lmpzb24kLylcbiAgICApO1xuICAgIGV4cGVjdChtb2NrUmVhZEZpbGVTeW5jLm1vY2suY2FsbHNbMF1bMV0pLnRvTWF0Y2hPYmplY3QoeyBlbmNvZGluZzogXCJ1dGYtOFwiIH0pO1xuICAgIGV4cGVjdChtb2NrR2V0Um9sZUNyZWRlbnRpYWxzQ29tbWFuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgYWNjb3VudElkOiBzc29Db25maWcuc3NvX2FjY291bnRfaWQsXG4gICAgICByb2xlTmFtZTogc3NvQ29uZmlnLnNzb19yb2xlX25hbWUsXG4gICAgICBhY2Nlc3NUb2tlbjogdG9rZW4uYWNjZXNzVG9rZW4sXG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KFwic2hvdWxkIGFsbG93IHN1cHBseWluZyBjdXN0b20gY2xpZW50XCIsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IGRlZmF1bHQ6IHNzb0NvbmZpZyB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShcImRlZmF1bHRcIik7XG4gICAgbW9ja1JlYWRGaWxlU3luYy5tb2NrUmV0dXJuVmFsdWUoSlNPTi5zdHJpbmdpZnkodG9rZW4pKTtcbiAgICBjb25zdCBuZXdTU09DbGllbnQgPSB7IHNlbmQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoUHJvbWlzZS5yZXNvbHZlKG1vY2tSb2xlQ3JlZGVudGlhbHMpKSB9O1xuICAgIC8vQHRzLWV4cGVjdC1lcnJvclxuICAgIGF3YWl0IGZyb21TU08oeyBzc29DbGllbnQ6IG5ld1NTT0NsaWVudCB9KSgpO1xuICAgIGV4cGVjdChuZXdTU09DbGllbnQuc2VuZCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIGV4cGVjdChtb2NrU1NPU2VuZCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG5cbiAgaXQoXCJzaG91bGQgdGhyb3cgaWYgcHJvZmlsZSBkb2Vzbid0IGV4aXN0IGluIHRoZSBjb25maWcgZmlsZXNcIiwgKCkgPT4ge1xuICAgIGNvbnN0IHByb2ZpbGUgPSBcImV4aXN0XCI7XG4gICAgbW9ja1BhcnNlS25vd0ZpbGVzLm1vY2tSZXR1cm5WYWx1ZShQcm9taXNlLnJlc29sdmUoeyBub25fZXhpc3Q6IHsgZm9vOiBcImJhclwiIH0gfSkpO1xuICAgIG1vY2tHZXRNYXN0ZXJQcm9maWxlTmFtZS5tb2NrUmV0dXJuVmFsdWUocHJvZmlsZSk7XG4gICAgcmV0dXJuIGV4cGVjdChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBmcm9tU1NPKCkoKTtcbiAgICB9KS5yZWplY3RzLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgbWVzc2FnZTogYFByb2ZpbGUgJHtwcm9maWxlfSBjb3VsZCBub3QgYmUgZm91bmQgaW4gc2hhcmVkIGNyZWRlbnRpYWxzIGZpbGUuYCxcbiAgICAgIHRyeU5leHRMaW5rOiB0cnVlLFxuICAgIH0pO1xuICB9KTtcblxuICBpdChcInNob3VsZCB0aHJvdyBpZiBwcm9maWxlIGlzIG5vdCBjb25maWd1cmVkIHdpdGggU1NPIGNyZWRlbnRpYWxcIiwgKCkgPT4ge1xuICAgIGNvbnN0IHByb2ZpbGUgPSBcImV4aXN0XCI7XG4gICAgbW9ja1BhcnNlS25vd0ZpbGVzLm1vY2tSZXR1cm5WYWx1ZShQcm9taXNlLnJlc29sdmUoeyBbcHJvZmlsZV06IHsgZm9vOiBcImJhclwiIH0gfSkpO1xuICAgIG1vY2tHZXRNYXN0ZXJQcm9maWxlTmFtZS5tb2NrUmV0dXJuVmFsdWUocHJvZmlsZSk7XG4gICAgcmV0dXJuIGV4cGVjdChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBmcm9tU1NPKCkoKTtcbiAgICB9KS5yZWplY3RzLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgbWVzc2FnZTogYFByb2ZpbGUgJHtwcm9maWxlfSBpcyBub3QgY29uZmlndXJlZCB3aXRoIFNTTyBjcmVkZW50aWFscy5gLFxuICAgICAgdHJ5TmV4dExpbms6IHRydWUsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgT2JqZWN0LmtleXMoc3NvQ29uZmlnKS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGtleVRvUmVtb3ZlID0gT2JqZWN0LmtleXMoc3NvQ29uZmlnKVtpXTtcbiAgICBpdChgc2hvdWxkIHRocm93IGlmIHNzbyBjb25maWd1cmF0aW9uIGlzIG1pc3NpbmcgJHtrZXlUb1JlbW92ZX1gLCBhc3luYyAoKSA9PiB7XG4gICAgICBleHBlY3QuYXNzZXJ0aW9ucygyKTtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IHsgLi4uc3NvQ29uZmlnIH07XG4gICAgICAvL0B0cy1pZ25vcmVcbiAgICAgIGRlbGV0ZSBjb25maWdba2V5VG9SZW1vdmVdO1xuICAgICAgbW9ja1BhcnNlS25vd0ZpbGVzLm1vY2tSZXR1cm5WYWx1ZShQcm9taXNlLnJlc29sdmUoeyBkZWZhdWx0OiBjb25maWcgfSkpO1xuICAgICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShcImRlZmF1bHRcIik7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBmcm9tU1NPKCkoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgZXhwZWN0KGUubWVzc2FnZSkudG9Db250YWluKFwiUHJvZmlsZSBkZWZhdWx0IGRvZXMgbm90IGhhdmUgdmFsaWQgU1NPIGNyZWRlbnRpYWxzLlwiKTtcbiAgICAgICAgZXhwZWN0KGUudHJ5TmV4dExpbmspLnRvQmVGYWxzeSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaXQoXCJzaG91bGQgdGhyb3cgaWYgdG9rZW4gY2FjaGUgZmlsZSBpcyBub3QgZm91bmRcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGV4cGVjdC5hc3NlcnRpb25zKDIpO1xuICAgIG1vY2tSZWFkRmlsZVN5bmMubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkZpbGUgbm90IGZvdW5kLlwiKTtcbiAgICB9KTtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IGRlZmF1bHQ6IHNzb0NvbmZpZyB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShcImRlZmF1bHRcIik7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZyb21TU08oKSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGV4cGVjdChlLm1lc3NhZ2UpLnRvQ29udGFpbihcIlRoZSBTU08gc2Vzc2lvbiBhc3NvY2lhdGVkIHdpdGggdGhpcyBwcm9maWxlIGhhcyBleHBpcmVkIG9yIGlzIG90aGVyd2lzZSBpbnZhbGlkLlwiKTtcbiAgICAgIGV4cGVjdChlLnRyeU5leHRMaW5rKS50b0JlRmFsc3koKTtcbiAgICB9XG4gIH0pO1xuXG4gIGl0KFwic2hvdWxkIHRocm93IGlmIHRva2VuIGNhY2hlIGZpbGUgaXMgaW52YWxpZFwiLCBhc3luYyAoKSA9PiB7XG4gICAgZXhwZWN0LmFzc2VydGlvbnMoMik7XG4gICAgbW9ja1JlYWRGaWxlU3luYy5tb2NrUmV0dXJuVmFsdWUoXCJpbnZhbGlkIEpTT04gY29udGVudFwiKTtcbiAgICBtb2NrUGFyc2VLbm93RmlsZXMubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZSh7IGRlZmF1bHQ6IHNzb0NvbmZpZyB9KSk7XG4gICAgbW9ja0dldE1hc3RlclByb2ZpbGVOYW1lLm1vY2tSZXR1cm5WYWx1ZShcImRlZmF1bHRcIik7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZyb21TU08oKSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGV4cGVjdChlLm1lc3NhZ2UpLnRvQ29udGFpbihcIlRoZSBTU08gc2Vzc2lvbiBhc3NvY2lhdGVkIHdpdGggdGhpcyBwcm9maWxlIGhhcyBleHBpcmVkIG9yIGlzIG90aGVyd2lzZSBpbnZhbGlkLlwiKTtcbiAgICAgIGV4cGVjdChlLnRyeU5leHRMaW5rKS50b0JlRmFsc3koKTtcbiAgICB9XG4gIH0pO1xuXG4gIGl0KFwic2hvdWxkIHRocm93IGlmIHRva2VuIGNhY2hlIGlzIGV4cGlyZWRcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGV4cGVjdC5hc3NlcnRpb25zKDIpO1xuICAgIG1vY2tSZWFkRmlsZVN5bmMubW9ja1JldHVyblZhbHVlKHsgLi4udG9rZW4sIGV4cGlyYXRpb246IHRvUkZDMzMzOVN0cmluZyhub3cgKyBFWFBJUkVfV0lORE9XX01TIC0gMikgfSk7XG4gICAgbW9ja1BhcnNlS25vd0ZpbGVzLm1vY2tSZXR1cm5WYWx1ZShQcm9taXNlLnJlc29sdmUoeyBkZWZhdWx0OiBzc29Db25maWcgfSkpO1xuICAgIG1vY2tHZXRNYXN0ZXJQcm9maWxlTmFtZS5tb2NrUmV0dXJuVmFsdWUoXCJkZWZhdWx0XCIpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcm9tU1NPKCkoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBleHBlY3QoZS5tZXNzYWdlKS50b0NvbnRhaW4oXCJUaGUgU1NPIHNlc3Npb24gYXNzb2NpYXRlZCB3aXRoIHRoaXMgcHJvZmlsZSBoYXMgZXhwaXJlZCBvciBpcyBvdGhlcndpc2UgaW52YWxpZC5cIik7XG4gICAgICBleHBlY3QoZS50cnlOZXh0TGluaykudG9CZUZhbHN5KCk7XG4gICAgfVxuICB9KTtcblxuICBpdChcInNob3VsZCB0aHJvdyBpZiBTU08gY2xpZW50IHRocm93c1wiLCBhc3luYyAoKSA9PiB7XG4gICAgZXhwZWN0LmFzc2VydGlvbnMoMyk7XG4gICAgbW9ja1BhcnNlS25vd0ZpbGVzLm1vY2tSZXR1cm5WYWx1ZShQcm9taXNlLnJlc29sdmUoeyBkZWZhdWx0OiBzc29Db25maWcgfSkpO1xuICAgIG1vY2tHZXRNYXN0ZXJQcm9maWxlTmFtZS5tb2NrUmV0dXJuVmFsdWUoXCJkZWZhdWx0XCIpO1xuICAgIG1vY2tSZWFkRmlsZVN5bmMubW9ja1JldHVyblZhbHVlKEpTT04uc3RyaW5naWZ5KHRva2VuKSk7XG4gICAgY29uc3QgY2xpZW50RXJyb3IgPSBuZXcgRXJyb3IoXCJObyBhY2NvdW50IGlzIGZvdW5kIGZvciB0aGUgdXNlclwiKTtcbiAgICAvL0B0cy1pZ25vcmVcbiAgICBjbGllbnRFcnJvci4kZmF1bHQgPSBcImNsaWVudFwiO1xuICAgIG1vY2tTU09TZW5kLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICB0aHJvdyBjbGllbnRFcnJvcjtcbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZnJvbVNTTygpKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZXhwZWN0KGUubWVzc2FnZSkudG9Db250YWluKGNsaWVudEVycm9yLm1lc3NhZ2UpO1xuICAgICAgZXhwZWN0KGUudHJ5TmV4dExpbmspLnRvQmVGYWxzeSgpO1xuICAgICAgZXhwZWN0KGUuJGZhdWx0KS50b0JlKFwiY2xpZW50XCIpO1xuICAgIH1cbiAgfSk7XG5cbiAgaXQoXCJzaG91bGQgdGhyb3cgaWYgY3JlZGVudGlhbHMgZnJvbSBTU08gY2xpZW50IGlzIGludmFsaWRcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGV4cGVjdC5hc3NlcnRpb25zKDIpO1xuICAgIG1vY2tSZWFkRmlsZVN5bmMubW9ja1JldHVyblZhbHVlKEpTT04uc3RyaW5naWZ5KHRva2VuKSk7XG4gICAgbW9ja1BhcnNlS25vd0ZpbGVzLm1vY2tSZXR1cm5WYWx1ZShQcm9taXNlLnJlc29sdmUoeyBkZWZhdWx0OiBzc29Db25maWcgfSkpO1xuICAgIG1vY2tHZXRNYXN0ZXJQcm9maWxlTmFtZS5tb2NrUmV0dXJuVmFsdWUoXCJkZWZhdWx0XCIpO1xuICAgIG1vY2tTU09TZW5kLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIHJvbGVDcmVkZW50aWFsczogeyAuLi5tb2NrUm9sZUNyZWRlbnRpYWxzLnJvbGVDcmVkZW50aWFscywgYWNjZXNzS2V5SWQ6IHVuZGVmaW5lZCB9LFxuICAgIH0pO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcm9tU1NPKCkoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBleHBlY3QoZS5tZXNzYWdlKS50b0NvbnRhaW4oXCJTU08gcmV0dXJucyBhbiBpbnZhbGlkIHRlbXBvcmFyeSBjcmVkZW50aWFsLlwiKTtcbiAgICAgIGV4cGVjdChlLnRyeU5leHRMaW5rKS50b0JlRmFsc3koKTtcbiAgICB9XG4gIH0pO1xufSk7XG4iXX0=